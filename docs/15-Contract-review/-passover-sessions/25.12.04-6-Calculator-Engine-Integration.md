# Session 6: Calculator Engine Integration Planning

**Date:** December 4, 2025 (Updated: December 7, 2025)
**Project:** APR Dashboard V3
**Focus:** Preview auto-scroll feature + Valcre calculator engine review + V3 Integration Confirmation

---

## Search Keywords

`preview-auto-scroll`, `section-scroll`, `activeSection`, `PreviewRenderer`, `section-IDs`, `reportBuilderStore`, `CALC-section`, `ValuationWorkbench`, `calculateValuation`, `calculateExpense`, `ExpenseBase`, `percent_pgr`, `percent_egr`, `per_unit`, `per_sf`, `PGR`, `EGR`, `NOI`, `cap-rate`, `direct-capitalization`, `Valcre-accurate`, `expense-calculation`, `post-value-adjustments`, `sync-IMPV-to-CALC`, `recon-income-value`, `scrollToSection`, `smooth-scroll`, `zoom-factor`, `runCalculations`

---

## Session Overview

Continued from session 5. This session focused on:
1. Implementing auto-scroll in preview when section tabs are clicked
2. Reviewing the CALC section field structure proposal
3. Analyzing the ValuationWorkbench.tsx calculator engine for integration
4. **Confirming V3 already has the complete validated calculation engine**

---

## Critical Finding: V3 Engine Already Complete

**Discovery Date:** December 7, 2025

After validating the standalone ValuationWorkbench against Valcre Excel, we confirmed that **V3's report builder already contains the identical validated calculation engine**.

### Engine Location in V3

**File:** `src/features/report-builder/store/reportBuilderStore.ts`
**Function:** `runCalculations()` (lines 3181-3374)

The production calculation engine is embedded directly in the report builder store, not in a separate utility file.

### What This Means

| Component | Location | Purpose |
|-----------|----------|---------|
| **Production Engine** | V3 `reportBuilderStore.ts` | Live calculations in report builder |
| **Validation Tool** | V2-Res `/08-Calculator/ValuationWorkbench.tsx` | Standalone testing UI |

The ValuationWorkbench was built to **validate the calculation logic** - it was never meant to be migrated. V3 was built with the same logic from the start.

---

## V3 Calculation Engine Architecture

### Core Function: `runCalculations()`

**Location:** `reportBuilderStore.ts:3181-3374` (193 lines)

```typescript
runCalculations: () => {
  // 1. Helper functions
  const getFieldValue = (fieldId: string): number => {...}
  const getExpenseBase = (fieldId: string): string => {...}

  // 2. Unit Mix Calculations (4 unit types)
  // 3. Other Income (parking, laundry, other)
  // 4. PGR = Rental Revenue + Other Income
  // 5. Vacancy/Loss Calculations
  // 6. EGR = PGR - Vacancy Loss
  // 7. Operating Expenses (with 5 calc bases)
  // 8. NOI = EGR - Total Expenses
  // 9. Cap Rate Valuation
  // 10. Rounding to $10,000
  // 11. Post-Value Adjustments
  // 12. Indicated Value
  // 13. Sync to RECON section
}
```

### Expense Calculation Logic (Lines 3265-3282)

```typescript
const calculateExpense = (fieldId: string): number => {
  const value = getFieldValue(fieldId);
  const base = getExpenseBase(fieldId);
  switch (base) {
    case "percent_pgr": return pgr * (value / 100);
    case "percent_egr": return egr * (value / 100);
    case "fixed": return value;
    case "per_unit": return value * totalUnits;
    case "per_sf": return value * totalSf;
    default: return value * totalUnits;
  }
};
```

### Expense Fields with Calc Base (Lines 2066-2150)

| Field ID | Label | Default Base | Default Value |
|----------|-------|--------------|---------------|
| `calc-exp-management` | Management | `percent_egr` | 4.25 |
| `calc-exp-taxes` | Real Estate Taxes | `per_unit` | 0 |
| `calc-exp-insurance` | Insurance | `per_unit` | 0 |
| `calc-exp-repairs` | Repairs & Maintenance | `per_unit` | 0 |
| `calc-exp-utilities` | Utilities | `per_unit` | 0 |
| `calc-exp-payroll` | Payroll | `per_unit` | 0 |
| `calc-exp-admin` | Admin & General | `per_unit` | 0 |
| `calc-exp-reserves` | Replacement Reserves | `per_unit` | 0 |
| `calc-exp-other` | Other Expenses | `per_unit` | 0 |

**Critical:** Management uses `percent_egr` - this is what makes it match Valcre Excel exactly.

### Output Field Updates (Lines 3326-3371)

The engine updates these calculated fields automatically:

**Unit Mix:**
- `calc-type1-annual` through `calc-type4-annual`
- `calc-total-units`, `calc-total-sf`, `calc-avg-unit-sf`
- `calc-total-rental-revenue`, `calc-avg-rent-per-unit`, `calc-avg-rent-per-sf`

**Income:**
- `calc-parking-total`, `calc-laundry-total`, `calc-total-other-income`
- `calc-pgr`, `calc-vacancy-loss`, `calc-egr`

**Expenses:**
- `calc-expenses-total`, `calc-expense-ratio`

**Results:**
- `calc-noi`, `calc-noi-per-unit`, `calc-noi-per-sf`
- `calc-raw-value`, `calc-indicated-value`
- `calc-value-per-unit`, `calc-value-per-sf`, `calc-grm`

**RECON Sync:**
- `recon-income-value` (receives `calc-indicated-value`)

---

## Deliverables

### 1. Preview Auto-Scroll Feature

**Files Modified:**
- `reportHtmlTemplate.ts` - Added section IDs and smooth scroll CSS
- `PreviewRenderer.tsx` - Added activeSection scroll effect

**Implementation:**
- Added `id="section-{sectionId}"` to each page div in HTML template
- Added `scroll-behavior: smooth` to CSS html element
- Added `scroll-margin-top: 20px` to `.page` class
- PreviewRenderer listens to `activeSection` changes from store
- Calculates section position within iframe, applies zoom factor
- Smoothly scrolls outer container to target section

**Section IDs Added:**
| Page | ID |
|------|-----|
| Cover | `section-cover` |
| Letter of Transmittal | `section-home` |
| Executive Summary | `section-exec` |
| Dynamic sections | `section-${section.id}` |
| Certification | `section-cert` |

---

### 2. CALC Section Structure Review

**Proposed placement:** After HBU section, before LAND1

**Purpose:** Self-contained calculator sandbox with "Test Calculate" button

**Relationship to existing sections:**
| Section | Purpose | Status |
|---------|---------|--------|
| IMPV | Building details for report narrative | Unchanged |
| INCOME | Income approach narrative for report | Unchanged |
| **CALC** | Calculator sandbox with test button | **Implemented** |
| RECON | Final reconciliation | Receives `calc-indicated-value` |

**Integration points:**
- Sync FROM: `impv-num-units`, `impv-nra`
- Push TO: `recon-income-value`

---

### 3. ValuationWorkbench Engine Analysis

**Source file:** `/Users/bencrowe/Development/APR-Dashboard-v2-Res/01-APR-Resources/08-Calculator/ValuationWorkbench.tsx`

**Purpose:** Standalone validation tool to confirm calculation logic matches Valcre Excel

**Key functions:**

```typescript
// Expense calculation (5 bases)
type ExpenseBase = 'percent_pgr' | 'percent_egr' | 'fixed' | 'per_unit' | 'per_sf';

calculateExpense(expense, pgr, egr, units, sqft) {
  switch (expense.calcBase) {
    case 'percent_pgr': return pgr * (expense.value / 100);
    case 'percent_egr': return egr * (expense.value / 100);
    case 'fixed': return expense.value;
    case 'per_unit': return expense.value * units;
    case 'per_sf': return expense.value * sqft;
  }
}

// Main calculation flow
calculateValuation() {
  PGR = Rental + Other Revenue
  EGR = PGR - (PGR × totalVacancyRate / 100)
  NOI = EGR - Total Expenses
  Raw Value = NOI / (capRate / 100)
  Rounded = Math.round(rawValue / 10000) * 10000
  Indicated = Rounded - Adjustments
}
```

---

## Decisions Made

1. **Scroll mechanism:** Scroll outer container (not iframe internal) with zoom factor applied
2. **CALC section is additive:** Does not replace INCOME section
3. **Use validated engine:** Don't rebuild from scratch, port existing Valcre-accurate logic
4. **Expense base options:** Must support all 5 types from original engine
5. **No migration needed:** V3 already has complete engine in `reportBuilderStore.ts`

---

## Problems Solved

| Problem | Solution |
|---------|----------|
| Preview scroll not working | Scroll outer container, not iframe; apply zoom factor |
| Calculating scroll position | Get section rect relative to body, multiply by zoom |
| CALC vs INCOME confusion | Clarified: CALC = calculator sandbox, INCOME = report narrative |
| Wrong expense calc bases | Fixed test data to use `per_unit` for most expenses, `percent_egr` for management |
| Engine location confusion | Confirmed: V3 production engine is in `reportBuilderStore.ts`, validation tool in V2-Res |

---

## Files Reference

**V3 Production Code:**
```
src/features/report-builder/store/reportBuilderStore.ts
├── runCalculations()           [lines 3181-3374]
├── CALC section definition     [lines ~1950-2200]
└── loadFullTestData()          [lines 3376-3420]
```

**V2-Res Validation Tool:**
```
/Users/bencrowe/Development/APR-Dashboard-v2-Res/01-APR-Resources/
├── 08-Calculator/ValuationWorkbench.tsx                    [747 lines - standalone UI]
└── 14-Contract-Generator/Report-Generator/src/pages/
    └── ValuationWorkbench.tsx                              [747 lines - route copy]
```

**Modified in Session 6:**
```
src/features/report-builder/
├── templates/reportHtmlTemplate.ts  [section IDs + smooth scroll CSS]
└── components/PreviewPanel/PreviewRenderer.tsx  [scroll effect]
```

---

## Task Status (Updated Dec 7)

| Task | Status |
|------|--------|
| Add CALC section to `reportBuilderStore.ts` | ✅ Complete |
| Update types to include `expenseCalcBase` field property | ✅ Complete |
| Wire `calculateValuation()` into `updateCalculatedFields()` | ✅ Complete (as `runCalculations()`) |
| Add sync logic: IMPV → CALC fields | ⏳ Pending |
| Add push logic: `calc-indicated-value` → `recon-income-value` | ✅ Complete |
| Add post-value adjustments subsection to CALC | ✅ Complete |
| Create "Test Calculate" button in UI | ⏳ Pending (in CALC section) |

---

## Technical Notes

### Scroll Position Calculation
```typescript
// Get section position within iframe
const sectionRect = sectionElement.getBoundingClientRect();
const bodyRect = iframeDoc.body.getBoundingClientRect();
const sectionTop = sectionRect.top - bodyRect.top;

// Apply zoom and padding
const scrollTarget = (sectionTop * zoom) + 32;

// Smooth scroll container
containerRef.current.scrollTo({ top: scrollTarget, behavior: 'smooth' });
```

### Expense Calculation Pattern
```typescript
// Each expense has calcBase property determining how value is applied
switch (calcBase) {
  case 'percent_pgr': return pgr * (value / 100);      // % of Potential Gross
  case 'percent_egr': return egr * (value / 100);      // % of Effective Gross
  case 'fixed': return value;                           // Fixed dollar amount
  case 'per_unit': return value * units;               // $/unit × units
  case 'per_sf': return value * sqft;                  // $/SF × square feet
}
```

### Valuation Rounding (Appraisal Standard)
```typescript
// Round to nearest $10,000 (standard appraisal practice)
const roundedValue = Math.round(rawValue / 10000) * 10000;
```

---

## Calculator Engine Validation

**Validation performed in separate terminal session (Marcel Superagent)**

### Test Data (Valcre Excel Values)

```typescript
// Property
units: 14
sqft: 11480
capRate: 6.25

// Income
rentalRevenue: $204,240/year (from 4 unit types)
parkingRevenue: 0
laundryRevenue: 0
otherRevenue: 0
totalVacancy: 4%

// Expenses (all per_unit except management)
taxes: $1,168/unit
insurance: $710/unit
repairs: $830/unit
payroll: $500/unit
utilities: $1,315/unit
management: 4.25% of EGR  // CRITICAL: uses EGR, not PGR
other: $245/unit
```

### Validation Results

| Metric | Expected (Valcre) | Calculator Output | Status |
|--------|-------------------|-------------------|--------|
| PGR | $204,240 | $204,240 | ✅ Exact |
| Vacancy Loss (4%) | $8,170 | $8,170 | ✅ Exact |
| EGR | $196,070 | $196,070 | ✅ Exact |
| Total OpEx | $84,621 | $84,621 | ✅ Exact |
| NOI | $111,449 | $111,449 | ✅ Exact |
| Raw Value | $1,783,191 | $1,783,191 | ✅ Exact |
| **Indicated Value** | **$1,780,000** | **$1,780,000** | ✅ Exact |

### Engine Features Confirmed Working

- ✅ 5 expense calculation bases (percent_pgr, percent_egr, fixed, per_unit, per_sf)
- ✅ Income breakdown (rental by unit type, parking, laundry, other)
- ✅ Vacancy + Bad Debt + Concessions
- ✅ Rounding to nearest $10,000
- ✅ Post-value adjustments (CapEx, Leasing, Other)
- ✅ All ratios (NOI/unit, NOI/SF, Value/unit, Value/SF, GRM)
- ✅ Automatic sync to RECON section

---

## Key Learnings

### 1. Management Fees Must Use EGR
The critical insight that makes the calculator match Valcre: **Management fees are calculated as a percentage of EGR (Effective Gross Revenue), not PGR (Potential Gross Revenue)**.

This is because management fees are collected on actual collected rent, not potential rent. Vacancy reduces the base for management fee calculation.

### 2. Expense Calc Base Selection
Most operating expenses in multifamily are expressed as **$/unit**. Only percentage-based fees (like management) use the revenue-based calculations.

| Expense Type | Typical Base | Reason |
|--------------|--------------|--------|
| Taxes | per_unit | Fixed per unit regardless of rent |
| Insurance | per_unit | Based on building, not income |
| Utilities | per_unit | Usage-based, correlates to units |
| Management | percent_egr | Fee on collected revenue |
| Reserves | per_unit | Capital planning per unit |

### 3. Rounding Convention
Appraisers round indicated values to the nearest $10,000 for final reporting. This is industry standard and implemented as:
```typescript
Math.round(rawValue / 10000) * 10000
```

---

## Session Statistics

- **Features implemented:** 1 (preview auto-scroll)
- **Structures reviewed:** 2 (CALC proposal, ValuationWorkbench engine)
- **Files modified:** 2
- **Calculator validated:** ✅ $1,780,000 matches Valcre Excel
- **V3 engine confirmed:** ✅ Complete at `reportBuilderStore.ts:3181-3374`

---

## Remaining Work

1. **IMPV → CALC Sync:** Wire `impv-num-units` and `impv-nra` to auto-populate CALC fields
2. **Test Calculate Button:** Add UI button in CALC section to trigger `runCalculations()`
3. **Expense Calc Base Selector:** Add dropdown UI to let users change expense calculation basis

---

## Document History

| Date | Update |
|------|--------|
| Dec 4, 2025 | Initial session - preview scroll + CALC review |
| Dec 7, 2025 | Validation complete, V3 engine location confirmed |
