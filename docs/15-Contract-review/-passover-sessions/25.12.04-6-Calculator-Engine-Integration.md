# Session 6: Calculator Engine Integration Planning

**Date:** December 4, 2025
**Project:** APR Dashboard V3
**Focus:** Preview auto-scroll feature + Valcre calculator engine review

---

## Search Keywords

`preview-auto-scroll`, `section-scroll`, `activeSection`, `PreviewRenderer`, `section-IDs`, `reportBuilderStore`, `CALC-section`, `ValuationWorkbench`, `calculateValuation`, `calculateExpense`, `ExpenseBase`, `percent_pgr`, `percent_egr`, `per_unit`, `per_sf`, `PGR`, `EGR`, `NOI`, `cap-rate`, `direct-capitalization`, `Valcre-accurate`, `expense-calculation`, `post-value-adjustments`, `sync-IMPV-to-CALC`, `recon-income-value`, `scrollToSection`, `smooth-scroll`, `zoom-factor`

---

## Session Overview

Continued from session 5. This session focused on:
1. Implementing auto-scroll in preview when section tabs are clicked
2. Reviewing the CALC section field structure proposal
3. Analyzing the ValuationWorkbench.tsx calculator engine for integration

---

## Deliverables

### 1. Preview Auto-Scroll Feature

**Files Modified:**
- `reportHtmlTemplate.ts` - Added section IDs and smooth scroll CSS
- `PreviewRenderer.tsx` - Added activeSection scroll effect

**Implementation:**
- Added `id="section-{sectionId}"` to each page div in HTML template
- Added `scroll-behavior: smooth` to CSS html element
- Added `scroll-margin-top: 20px` to `.page` class
- PreviewRenderer listens to `activeSection` changes from store
- Calculates section position within iframe, applies zoom factor
- Smoothly scrolls outer container to target section

**Section IDs Added:**
| Page | ID |
|------|-----|
| Cover | `section-cover` |
| Letter of Transmittal | `section-home` |
| Executive Summary | `section-exec` |
| Dynamic sections | `section-${section.id}` |
| Certification | `section-cert` |

---

### 2. CALC Section Structure Review

**Proposed placement:** After HBU section, before LAND1

**Purpose:** Self-contained calculator sandbox with "Test Calculate" button

**Relationship to existing sections:**
| Section | Purpose | Status |
|---------|---------|--------|
| IMPV | Building details for report narrative | Unchanged |
| INCOME | Income approach narrative for report | Unchanged |
| **CALC** | Calculator sandbox with test button | **New** |
| RECON | Final reconciliation | Receives `calc-indicated-value` |

**Integration points:**
- Sync FROM: `impv-num-units`, `impv-nra`
- Push TO: `recon-income-value`

---

### 3. ValuationWorkbench Engine Analysis

**Source file:** `/Users/bencrowe/Development/APR-Dashboard-v2-Res/01-APR-Resources/08-Calculator/ValuationWorkbench.tsx`

**Key functions:**

```typescript
// Expense calculation (5 bases)
type ExpenseBase = 'percent_pgr' | 'percent_egr' | 'fixed' | 'per_unit' | 'per_sf';

calculateExpense(expense, pgr, egr, units, sqft) {
  switch (expense.calcBase) {
    case 'percent_pgr': return pgr * (expense.value / 100);
    case 'percent_egr': return egr * (expense.value / 100);
    case 'fixed': return expense.value;
    case 'per_unit': return expense.value * units;
    case 'per_sf': return expense.value * sqft;
  }
}

// Main calculation flow
calculateValuation() {
  PGR = Rental + Other Revenue
  EGR = PGR - (PGR × totalVacancyRate / 100)
  NOI = EGR - Total Expenses
  Raw Value = NOI / (capRate / 100)
  Rounded = Math.round(rawValue / 10000) * 10000
  Indicated = Rounded - Adjustments
}
```

**Gaps identified in proposed CALC structure:**
- Missing `percent_pgr` expense base (only had `percent_egr`)
- Missing `per_sf` expense base
- Missing post-value adjustments (CapEx, Leasing, Other)

---

## Decisions Made

1. **Scroll mechanism:** Scroll outer container (not iframe internal) with zoom factor applied
2. **CALC section is additive:** Does not replace INCOME section
3. **Use validated engine:** Don't rebuild from scratch, port existing Valcre-accurate logic
4. **Expense base options:** Must support all 5 types from original engine

---

## Problems Solved

| Problem | Solution |
|---------|----------|
| Preview scroll not working | Scroll outer container, not iframe; apply zoom factor |
| Calculating scroll position | Get section rect relative to body, multiply by zoom |
| CALC vs INCOME confusion | Clarified: CALC = calculator sandbox, INCOME = report narrative |

---

## Files Reference

**Modified this session:**
```
src/features/report-builder/
├── templates/reportHtmlTemplate.ts  [section IDs + smooth scroll CSS]
└── components/PreviewPanel/PreviewRenderer.tsx  [scroll effect]
```

**Reviewed (not modified):**
```
src/features/report-builder/store/reportBuilderStore.ts  [2901 lines]
/Users/bencrowe/Development/APR-Dashboard-v2-Res/01-APR-Resources/08-Calculator/ValuationWorkbench.tsx  [749 lines]
```

---

## Next Steps

1. [ ] Add CALC section to `reportBuilderStore.ts` (after HBU)
2. [ ] Update types to include `expenseCalcBase` field property
3. [ ] Wire `calculateValuation()` into `updateCalculatedFields()`
4. [ ] Add sync logic: IMPV → CALC fields
5. [ ] Add push logic: `calc-indicated-value` → `recon-income-value`
6. [ ] Add post-value adjustments subsection to CALC
7. [ ] Create "Test Calculate" button in UI

---

## Technical Notes

### Scroll Position Calculation
```typescript
// Get section position within iframe
const sectionRect = sectionElement.getBoundingClientRect();
const bodyRect = iframeDoc.body.getBoundingClientRect();
const sectionTop = sectionRect.top - bodyRect.top;

// Apply zoom and padding
const scrollTarget = (sectionTop * zoom) + 32;

// Smooth scroll container
containerRef.current.scrollTo({ top: scrollTarget, behavior: 'smooth' });
```

### Expense Calculation Pattern
```typescript
// Each expense has calcBase property determining how value is applied
switch (calcBase) {
  case 'percent_pgr': return pgr * (value / 100);      // % of Potential Gross
  case 'percent_egr': return egr * (value / 100);      // % of Effective Gross
  case 'fixed': return value;                           // Fixed dollar amount
  case 'per_unit': return value * units;               // $/unit × units
  case 'per_sf': return value * sqft;                  // $/SF × square feet
}
```

---

## Calculator Engine Validation (Updated)

**Validation performed in separate terminal session (Marcel Superagent)**

### Test Data Correction

Original test data used `percent_pgr` for expenses - **WRONG**.
Valcre Excel uses `per_unit` values. Fixed to:

```typescript
setExpenses([
  { id: 'taxes', label: 'Real Estate Taxes', calcBase: 'per_unit', value: 1168, enabled: true },
  { id: 'insurance', label: 'Insurance', calcBase: 'per_unit', value: 710, enabled: true },
  { id: 'repairs', label: 'Repairs & Maintenance', calcBase: 'per_unit', value: 830, enabled: true },
  { id: 'payroll', label: 'Payroll', calcBase: 'per_unit', value: 500, enabled: true },
  { id: 'utilities', label: 'Utilities', calcBase: 'per_unit', value: 1315, enabled: true },
  { id: 'management', label: 'Management Fees', calcBase: 'percent_egr', value: 4.25, enabled: true },
  { id: 'other', label: 'Other Expenses', calcBase: 'per_unit', value: 245, enabled: true },
]);
```

**Critical:** Management Fees uses `percent_egr` (not PGR) - this is what makes it match Valcre.

### Validation Results ✅

| Metric | Expected (Valcre) | Calculator Output | Status |
|--------|-------------------|-------------------|--------|
| PGR | $204,240 | $204,240 | ✅ Exact |
| Vacancy Loss (4%) | $8,170 | $8,170 | ✅ Exact |
| EGR | $196,070 | $196,070 | ✅ Exact |
| Total OpEx | $84,621 | $84,621 | ✅ Exact |
| NOI | $111,449 | $111,449 | ✅ Exact |
| Raw Value | $1,783,191 | $1,783,191 | ✅ Exact |
| **Indicated Value** | **$1,780,000** | **$1,780,000** | ✅ Exact |

### File Sync

Both locations now have identical validated version:
- `/08-Calculator/ValuationWorkbench.tsx` (747 lines)
- `/14-Contract-Generator/Report-Generator/src/pages/ValuationWorkbench.tsx`

### Engine Features Confirmed Working

- ✅ 5 expense calculation bases (percent_pgr, percent_egr, fixed, per_unit, per_sf)
- ✅ Income breakdown (rental, parking, laundry, storage, other)
- ✅ Vacancy + Bad Debt + Concessions
- ✅ Rounding to nearest $10,000
- ✅ Post-value adjustments (CapEx, Leasing, Other)
- ✅ All ratios (NOI/unit, NOI/SF, Value/unit, Value/SF)
- ✅ "Load Valcre Test Data" button for validation
- ✅ Dark theme UI

---

## Session Statistics

- **Features implemented:** 1 (preview auto-scroll)
- **Structures reviewed:** 2 (CALC proposal, ValuationWorkbench engine)
- **Files modified:** 2
- **Calculator validated:** ✅ $1,780,000 matches Valcre Excel
- **Duration:** Extended planning session
