# PropertyType & PropertyContact Field Mapping Investigation

## üö® CRITICAL SAFETY REQUIREMENTS

**DO NOT BREAK JOB CREATION - This is non-negotiable!**

### Safety Rules:
1. **Job creation MUST succeed** even if PropertyType/PropertyContact fail
2. **Graceful degradation** - Skip problematic fields, log warnings, continue
3. **Rollback capability** - If changes break anything, revert immediately
4. **Test incremental changes** - Fix one thing at a time, verify each step
5. **Preserve existing working code** - Don't touch ClientId, PropertyId, or core Job fields

### Testing Protocol:
1. Test with minimal payload first
2. Add fields one at a time
3. Verify job creation succeeds after each change
4. Check Valcre UI to confirm data appears correctly
5. **If ANY change breaks job creation, revert that change**

---

## üéØ Problems
1. **PropertyType field** is not consistently making it to Valcre's Property entity
2. **PropertyContact fields** (firstName, lastName, email, phone) are not being saved to Valcre
3. These two issues may be related - both involve Property entity creation

## üìã Current Data Flow

### 1. UI Component (`ClientSubmissionSection.tsx` lines 79-102)
**Dropdown Values:**
- Agriculture
- Building
- Healthcare
- Hospitality
- Industrial
- Land
- Manufactured Housing
- Multi-Family
- Office
- Retail
- Self-Storage
- Single-Family
- Special Purpose
- Unknown

**Storage:** `job.propertyType` (camelCase)

### 2. Webhook Handler (`valcre.ts` line 202)
```typescript
PropertyType: formData.propertyType || 'Commercial',
```
**Maps to:** `PropertyType` (PascalCase)

### 3. Vercel API (`api/valcre.ts` lines 564-571)
```typescript
if (jobData.PropertyType) {
  propertyData.PropertyType = jobData.PropertyType;
  console.log(`‚úÖ PropertyType set to: "${propertyData.PropertyType}"`);
} else {
  console.log(`‚ö†Ô∏è PropertyType is falsy, not setting on Property entity`);
}
```

## üîç Investigation Tasks

### Task 1: Verify Valcre API Accepts These Values
Check if Valcre's `Property.PropertyType` field expects these exact strings or different values.

**Reference:** `.docs/field-mapping.md` line 20 says `Property.PropertyType` is a "Dropdown value"

**Questions:**
1. Does Valcre have a different enum for PropertyType?
2. Should "Multi-Family" be "Multifamily"?
3. Should "Manufactured Housing" be something else?

### Task 2: Check Field Name Consistency
Verify the field name through the entire chain:
- ‚úÖ UI: `job.propertyType`
- ‚úÖ Webhook: `PropertyType`
- ‚úÖ API: `jobData.PropertyType`
- ‚ùì Valcre API: What field name does it actually expect?

### Task 3: Test Data Generation
Current test data (line 135):
```typescript
const propertyTypes = ['Multi-Family', 'Office', 'Retail', 'Industrial', 'Building'];
```

**Action:** Create a test that logs the FULL request to Valcre and the response to see if PropertyType is being rejected.

### Task 4: Check Property Entity Structure
From `api/valcre.ts` lines 551-642, the Property entity is created with:
```typescript
const propertyData: any = {
  Name: propertyName,
  AddressStreet: ...,
  AddressCity: ...,
  AddressState: ...,
  AddressPostalCode: ...,
  PropertyType: jobData.PropertyType,  // ‚Üê Is this the right field name?
  // ... other fields
};
```

**Question:** Does Valcre's `/api/v1/Properties` endpoint expect:
- `PropertyType` (what we're sending)
- `Type` (singular)
- `Types` (plural - see line 574: `PropertyTypeEnum` maps to `Types`)
- Something else?

## üéØ Recommended Approach

1. **Add comprehensive logging** to see EXACTLY what's being sent to Valcre
2. **Check Valcre API response** for error messages about PropertyType
3. **Compare with working fields** (like AddressStreet) to see format differences
4. **Test with minimal payload** - send ONLY PropertyType to isolate the issue

## üìÅ Files to Check
- `/Users/bencrowe/Development/apr-dashboard-v3/src/components/dashboard/job-details/ClientSubmissionSection.tsx` (lines 79-102)
- `/Users/bencrowe/Development/apr-dashboard-v3/src/utils/webhooks/valcre.ts` (line 202)
- `/Users/bencrowe/Development/apr-dashboard-v3/api/valcre.ts` (lines 564-571, 640-642)
- `/Users/bencrowe/Development/apr-dashboard-v3/.docs/field-mapping.md` (line 20)

## üîß Potential Fixes

### Fix 1: Field Name
If Valcre expects `Type` not `PropertyType`:
```typescript
propertyData.Type = jobData.PropertyType;
```

### Fix 2: Enum Values
If Valcre expects different strings (check Valcre's API docs):
```typescript
const PROPERTY_TYPE_MAP: Record<string, string> = {
  'Multi-Family': 'Multifamily',
  'Manufactured Housing': 'ManufacturedHomes',
  // etc.
};
propertyData.PropertyType = PROPERTY_TYPE_MAP[jobData.PropertyType] || jobData.PropertyType;
```

### Fix 3: PropertyTypeEnum
Line 574 maps `PropertyTypeEnum` to `Types`:
```typescript
if (jobData.PropertyTypeEnum) propertyData.Types = jobData.PropertyTypeEnum;
```
Maybe PropertyType should use this field instead?

---

## üî¥ ISSUE #2: PropertyContact Fields Not Saving

### Current State (`api/valcre.ts` lines 480-542)

**Property Contact Detection Logic:**
```typescript
const needsSeparatePropertyContact =
  jobData.PropertyContact &&
  (jobData.PropertyContact.Email !== clientEmail ||
   jobData.PropertyContact.FirstName !== clientFirstName ||
   jobData.PropertyContact.LastName !== clientLastName);
```

**Problem Areas:**

#### 1. Field Name Mapping
UI sends:
- `job.propertyContactFirstName`
- `job.propertyContactLastName`
- `job.propertyContactEmail`
- `job.propertyContactPhone`

Webhook expects:
- `jobData.PropertyContact.FirstName`
- `jobData.PropertyContact.LastName`
- `jobData.PropertyContact.Email`
- `jobData.PropertyContact.PhoneNumber` (note: NOT Phone!)

**Question:** Does the webhook properly map these fields?

#### 2. Critical Fix Comment (line 537-539)
```typescript
// CRITICAL FIX: Leave propertyContactId as null - don't default to clientId
// This prevents duplicate contact display in Valcre UI
propertyContactId = null;
```

**Why this was added:** PropertyContact was showing duplicate contacts in Valcre

**Current behavior:**
- If property contact = client contact ‚Üí `propertyContactId` stays `null`
- If property contact differs ‚Üí Creates separate Contact entity
- Job references: `ClientId` (required) and `PropertyContactId` (optional)

#### 3. Contact Creation (`api/valcre.ts` lines 499-542)

**üîë CRITICAL: PropertyContact must be linked to Appraiser's ID**

Current code:
```typescript
if (needsSeparatePropertyContact) {
  const propertyContactData = {
    Company: jobData.PropertyContact.Company || contactCompany,
    FirstName: jobData.PropertyContact.FirstName || clientFirstName,
    LastName: jobData.PropertyContact.LastName || clientLastName,
    AddressStreet: jobData.PropertyContact.AddressStreet || addressParts.street,
    // ... more fields
    OwnerId: 7095,  // ‚Üê Chris's appraiser ID - MUST be set correctly
  };

  // POST to /api/v1/Contacts ‚Üí Creates Contact entity in Valcre
  // Returns propertyContactId
}
```

**Then the Job links to it:**
```typescript
const jobCreateData: any = {
  Name: jobName,
  ClientId: clientId,        // ‚Üê Client contact (works)
  PropertyId: propertyId,    // ‚Üê Property (works)
  PropertyContactId: propertyContactId,  // ‚Üê Property contact (might be failing?)
  OwnerId: 7095,             // ‚Üê Appraiser who owns the job
};
```

**Critical Questions:**
1. Is `jobData.PropertyContact` object being properly constructed by the webhook?
2. Does the Contact entity POST succeed but PropertyContactId not link to Job?
3. Is OwnerId 7095 correct for ALL contacts, or does it need to match the appraiser?
4. Should fallback to `clientFirstName`/`clientLastName` even happen?

**The Duplication Bug (FIXED):**
- If PropertyContactId = ClientId ‚Üí Valcre shows duplicate contacts
- Fix: Leave PropertyContactId as NULL when same as client
- This works for "same as client" case
- But does it work for "different contact" case?

### PropertyContact Investigation Tasks

#### Task A: Trace Data Flow
1. **UI ‚Üí Webhook:**
   - Check `valcre.ts` - does it build `PropertyContact` object?
   - Look for mapping: `propertyContactFirstName` ‚Üí `PropertyContact.FirstName`

2. **Webhook ‚Üí API:**
   - Verify `jobData.PropertyContact` structure in API logs
   - Check if it's being sent at all

3. **API ‚Üí Valcre:**
   - Does the Contact entity POST succeed?
   - Check response for errors

#### Task B: Field Name Consistency
Current mapping chain:
```
UI: propertyContactEmail (camelCase)
  ‚Üì
Webhook: PropertyContact.Email (PascalCase, nested)
  ‚Üì
API: propertyContactData.Email (used in Contact entity)
  ‚Üì
Valcre: Contacts.Email
```

**Verify each step** - log the data at each transition point.

#### Task C: Test Scenarios
1. **Same as Client Contact:**
   - Should NOT create separate Contact entity
   - Should leave `PropertyContactId` as null
   - ‚úÖ This works (per line 537-541)

2. **Different Property Contact:**
   - SHOULD create separate Contact entity
   - SHOULD set `PropertyContactId` on Job
   - ‚ùå This might be failing

3. **Partial Property Contact:**
   - User fills only email, not name
   - What should happen?

#### Task D: Compare with Client Contact
Client contact creation works fine (lines 398-478). What's different?

**Client Contact:**
```typescript
ClientName: formData.clientName,
ClientEmail: formData.clientEmail,
ClientPhone: formData.clientPhone,
```
Simple, flat structure - works ‚úÖ

**Property Contact:**
```typescript
PropertyContact: {
  FirstName: formData.propertyContactFirstName,
  LastName: formData.propertyContactLastName,
  Email: formData.propertyContactEmail,
  PhoneNumber: formData.propertyContactPhone
}
```
Nested structure - might not be constructed properly ‚ùå

### Combined Investigation

**Hypothesis:** Both PropertyType and PropertyContact issues stem from the webhook not properly mapping fields.

**Safe Test Plan (DO NOT BREAK JOB CREATION):**

#### Phase 1: Add Logging (SAFE - No functional changes)
1. Add comprehensive logging to `valcre.ts`:
   - Log what UI sends to webhook
   - Log PropertyType value
   - Log PropertyContact object structure
   - Log full payload before sending to `/api/valcre`

2. Add logging to `/api/valcre.ts`:
   - Log what webhook sends
   - Log PropertyType value received
   - Log PropertyContact object received
   - Log Valcre API responses for Property and Contact creation

3. Test job creation - should still work, just with more logs

#### Phase 2: Verify Data Flow (SAFE - Investigation only)
1. Create test job with PropertyType filled
2. Create test job with different PropertyContact
3. Check Vercel logs to see exact data at each step
4. Compare with working fields (ClientEmail, PropertyAddress)
5. **DO NOT make code changes yet**

#### Phase 3: Identify Root Cause (ANALYSIS)
From logs, determine:
- Is PropertyType being sent? If no ‚Üí webhook issue
- Is PropertyType reaching Valcre? If yes but not saving ‚Üí field name/value issue
- Is PropertyContact.Email being sent? If no ‚Üí webhook issue
- Is Contact entity created? If yes but not linked ‚Üí PropertyContactId issue

#### Phase 4: Fix ONE Issue at a Time (CAREFUL)
**Fix PropertyType OR PropertyContact - NOT BOTH**

For PropertyType:
1. If field name wrong ‚Üí Try `Type` instead of `PropertyType`
2. If values wrong ‚Üí Add PROPERTY_TYPE_MAP like we have for other enums
3. Test job creation after change
4. If breaks ‚Üí REVERT immediately
5. If works ‚Üí Verify in Valcre UI

For PropertyContact:
1. Add webhook code to build `PropertyContact` object from flat fields
2. Test job creation after change
3. If breaks ‚Üí REVERT immediately
4. If works ‚Üí Verify separate contact appears in Valcre

#### Phase 5: Fix Second Issue (ONLY if Phase 4 succeeded)
Repeat Phase 4 for the other issue

#### Rollback Plan:
```bash
# If anything breaks:
git diff api/valcre.ts           # Check what changed
git checkout api/valcre.ts       # Revert API changes
git diff src/utils/webhooks/valcre.ts
git checkout src/utils/webhooks/valcre.ts  # Revert webhook changes
```

---

## üìÅ Additional Files to Check
- `/Users/bencrowe/Development/apr-dashboard-v3/src/components/dashboard/job-details/ClientSubmissionSection.tsx` (lines 436-470 - Property Contact UI)
- `/Users/bencrowe/Development/apr-dashboard-v3/src/utils/webhooks/valcre.ts` (check PropertyContact object construction)
- `/Users/bencrowe/Development/apr-dashboard-v3/api/valcre.ts` (lines 480-542 - PropertyContact creation)

---

## üöÄ Next Steps

1. Check Valcre's API documentation for Property entity AND Contacts entity
2. Look at a successful Property creation in Valcre's UI - what's the actual field value?
3. Compare with the old V2 repo field mapping
4. Test with browser DevTools to see the actual API request/response
5. **NEW:** Add comprehensive logging to trace PropertyContact data through entire chain
6. **NEW:** Test PropertyContact creation separately from Property creation
